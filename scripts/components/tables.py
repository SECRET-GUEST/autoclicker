

#         ████████     ██████
#        █░░░░░░░░██_██░░░░░░█
#       █░░░░░░░░░░░█░░░░░░░░░█
#      █░░░░░░░███░░░█░░░░░░░░░█
#      █░░░░███░░░███░█░░░████░█
#    █░░░██░░░░░░░░███░██░░░░██
#   █░░░░░░░░░░░░░░░░░█░░░░░░░░███
#   █░░░░░░░░░░░░░██████░░░░░████░░█
#   █░░░░░░░░░█████░░░████░░██░░██░░█
#  ██░░░░░░░███░░░░░░░░░░█░░░░░░░░███
# █░░░░░░░░░░░░░░█████████░░█████████
#█░░░░░░░░░░█████ ████   ████ █████ █
#█░░░░░░░░░░█      █ ███   █   ███ █ █
#█░░░░░░░░░░░░█   ████ ████    ██ ████
#░░░░░░░░░░░░░█████████░░░████████░░░█
#░░░░░░░░░░░░░░░░█░░░░░█░░░░░░░░░░░░█
#░░░░░░░░░░░░░░░░░░░░██░░░░█░░░░░░██
#░░░░░░░░░░░░░░░░░░██░░░░░░░███████
#░░░░░░░░░░░░░░░░██░░░░░░░░░░█░░░░░█                                            _____                                 _____                                            _____                                                   _____
#░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░█                                          /\    \                               /\    \                                          /\    \                                                 /\    \
#░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░█                      ::                 /::\    \                             /::\    \                                        /::\____\                                               /::\____\
#░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░█                                        /::::\    \                           /::::\    \           :::         ::           ::: ::/    /                         :                   :: ::/    /
#░░░░░░░░░░░█████████░░░░░░░░░░░░░░██                                       /::::::\    \                         /::::::\    \                               ::: : :::/    /                                              /:::/    /
#░░░░░░░░░░█▒▒▒▒▒▒▒▒███████████████▒▒█                                     /:::/\:::\    \                    :: ::::/\:::\    \                                  /:::/    /                                              /:::/    /
#░░░░░░░░░█▒▒███████▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒█                                    /:::/__\:::\    \                     /:::/__\:::\    \                                /:::/    /                                            :::: :/____/
#░░░░░░░░░█▒▒▒█▓▓▓▓██████████████████                                    /::::\   \:::\    \                   /::::\   \:::\    \                              /:::/    /                                              /::::\    \
#░░░░░░░░░██▒▒█▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█                                       /::::::\   \:::\    \                 /::::::\   \:::\    \                            /:       /      _____                                   /::::::\    \   _____
#░░░░░░░░░░█▒▒█▓█████████████████ ████                                 /:::/\:::\   \:::\ ___\               /:::/\:::\   \:::\____\                          /:::/____/      /\    \                                 /:::/\:::\    \ /\    \
#░░░░░░░░░░█▒▒██▓▓▒▓▒▓▒▓▒▒▒▒▒▒▒▒▓█▓▒▒▒█                               /:::/__\:::\   \:::|    |             /:::/  \:::\   \:::|    |                         :::|    /      /::\____\                        ::::::: :::/ : :::\    /::\____\
#░░░░░░░░░█▒▒████████▓▒███▓██▒▒▒▒▒▒▒▒▒█                  :            \:::\   \:::\  /:::|____|             \::/   |::::\  /:::|____|                      : :: :|____\     /:::/    /                               \::/    \:::\: ::::/    /
#░░░░░░░░░█▒▒▒▒▒▒▒▒▒█████████████▓█▓██                                 \:::\   \:::\/:::/    /               \/____|:::::\/:::/    /                          \:::\    \   /:::/    /                                 \/____/: :::\/:::/    /
#░░░░░░░░░░████████▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒█                                  \:::\   \::::::/    /                      |:::::::::/    /                            \:::\   :: : ::/    /                                 :  :  : : :::::::/    /
#░░░░░░░░░░░░░░░░░░██████████████████                                    \:::\   \::::/    /          :  :         |::|\::::/    /           ::                 \:::\    /:::/    /               ::::                          \::       /
#░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░█            ::                           \:::\  /:::/    /                      :: ::| \::/____/                                \:::\__/:::/    /                                              /:::/    /
#██░░░░░░░░░░░░░░░░░░░░░░░░░░░██                                           \:::\/:::/    /                         |::|  ~|                                       \::::::::/    /                                             : :::/    /
#▓██░░░░░░░░░░░░░░░░░░░░░░░░██                                              \::::::/    /                          |::|   |                                        \::::::/    /                                              /:::/    /
#▓▓▓███░░░░░░░░░░░░░░░░░░░░█                                                 \::::/    /                           \::|   |                                         \::::/    /                              ::: :           /:::/    /
#▓▓▓▓▓▓███░░░░░░░░░░░░░░░██                                 :                 \::/____/            :                \:|   |               :    ::::                  \::/____/                                               \::/    /
#▓▓▓▓▓▓▓▓▓███████████████▓▓█                                                   ⠋                                     \|___|                                           ⠩                                                      \/____/
#▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓██
#▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█                                                                                                                                                                                                                                               |                                                                    |                                      |
#▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█                                                                    |                                                                                                             |
#______________________________                                                                                                                       |                                                                                                                      |                                                                                                                                              |                    |
#___________________________
#_ ______ _____ _________
#/            /                                                         |                                |                       |                    |                |                       |                    |                |                       |                    |                     |                       |                    |
                
#       \                          |                                |                                               |  |                                          |                    |                                          |                       |                    |  |                                           |                    |        |                    |                              |
                

#     |               |                                 |
                
#                 |                                                |            |                                   |                               |                           |                               |                           |                               |                                |                               |
#          |                                  |                                     |
                
#                 |                     |                                                     |                                   |                               |     |                                   |                               |     |                                   |                               |          |                                   |                               |
#  |                          |                       |                    |
#          |                                    |                                         |     |                    |                                    | |     |                    |                                    | |     |                    |                                    |      |     |                                                        |
#     |                        |                                 |      |                                |                       |                    |                |                       |                    |                |                       |                    |                     |                       |                    |
                
#                     |                                                |      |                                   |                               |                         |                               |                         |                               |                              |                               |
#          |                                   |                               |                   |                                |                       |                    |          |                                |                       |                    |          |                                |                       |                    |               |                                |                                        |
                
#                 |                     |
#  |                                |                       |                    |            |                                |                       |                    |     |                                |                       |                    |     |                                |                       |                              |                                |
#          |                               |                                         |                              |                       |                    |                           |                       |                    |                           |                       |                    |                                |                       |                    |
                
#  |         |                                   PRESENTATION                                                |                                |                    |   |                                |                    |   |                                |                    |        |                                |                    |
#                                                                                                                              |                               |     |                                   |                               |     |                                   |                               |          |                                   |                               |
#               |                             /                 \                          |                                                                              |                               |     |                                   |                               |     |                                   |                               |          |                                   |                               |
                
#       |                              An autoclicker who repeat action                    |                                           |               |                                           |               |                                           |                    |                                           |
                
#                          /                      |    v    |                    \
                
#                     from a list with almost all possibilities that offer a computer        |                                |                                          |      |                                |                                          |      |                                |                                          |           |                                |  
#     |                  !      |                                   |     |                                |                       |                    |                |                       |                    |                |                       |                    |                    |                                           |
#                               |                                   |     |                  
#                  |            |                   Anyway          !                        |                                         |                                |                       |                    |                |                       |                    |                |                       |                    |                    |
                
#             |                      |                 have                                                 |                        |                                         |                                |                       |                    |                |                       |                    |                |                       |                    |                     |                                           |
                

#                |                                  FUN         |                        |                                         |                                |                       |                    |                |                       |                    |                |                       |                    |                    |                                                                      |
                
#                                                        =)
                
#
#                               |                      or                                       |                                                            |                    |                |                       |                    |                |                       |                    |                    |                                           |
                

#             |                              |       DIE ! ! !        |                       |                            |                |                       |                    |                |                       |                    |                    |                                           |#     |                        |                                         |                                |
                
#
#                                                    !                                       |                                |                    |  |                                |                    |  |                                |                    |       |                                |                    |
                
#     |               |                                 !
                
#                 |                                                |            |                                   |                               |                           |                               |                           |                               |                                |                               |
#          |                                  !                                     |
                
#                 |                     |                                                     |                                   |                               |     |                                   |                               |     |                                   |                               |          |                                   |                               |
#  |                          |                       |                    !
#          |                                    |                                         |     |                    |                                    | |     |                    |                                    | |     |                    |                                    |      |     |                    |                                    |
#     |                        |                                 |      |                                |                       |                    |                |                       |                    |                |                       |                    |                    |                                           |
                
#                     |                                                |      |                                   |                               |                         |                               |                         |                               |                              |                               |
#          |                                   |                               |                   |                                |                       |                    |          |                                |                       |                    |          |                                |                       |                    |               |                                                                |
                
#                 |                     |
#  |                                |                       |                    |            |                                |                       |                    |     |                                |                       |                    |                                    |                       |                              |                                                                        |
#          |                               |                                         !                              |                       |                    |                           |                       |                    |                           |                       |                    |                                |                       |                    |
                
#_ _  _ ____ ___ ____ _    _    ____ ___ _ ____ _  _
#| |\ | [__   |  |__| |    |    |__|  |  | |  | |\ |
#| | \| ___]  |  |  | |___ |___ |  |  |  | |__| | \|
    
import  time,threading,uuid, random

from PyQt5.QtCore import Qt,QTimer
from PyQt5.QtWidgets import (QMainWindow, QVBoxLayout,QHBoxLayout, QTableWidget, QSpacerItem,
                            QPushButton,QCheckBox,  QWidget, QComboBox, QLabel, QLineEdit, QSpinBox, 
                            QDoubleSpinBox, QFileDialog,QSizePolicy)

from pynput import mouse
from pynput.mouse import  Controller as MouseController, Button
from pynput.mouse import Listener as MouseListener
from pynput.keyboard import Key, Controller as KeyboardController
from pynput.keyboard import Listener

from functools import partial

#___  ____ _ _ _ ____ ____    ___  _    ____ _  _ ___
#|__] |  | | | | |___ |__/    |__] |    |__| |\ |  |
#|    |__| |_|_| |___ |  \    |    |___ |  | | \|  |
                

#OPENING | https://www.youtube.com/watch?v=_85LaeTCtV8 :3



class DarthBMO(QMainWindow):

    def __init__(self, logger):
        super().__init__()

        self.logger = logger

        # Initialize some variables needed to record the scroll method
        self.recording_scroll = False
        self.scroll_amount = 0
        self.mouse_controller = MouseController()

        #Set uniques ID for any row to avoid errors
        self.row_ids = set()

        self.GUI()




    def launch_script_thread(self):
        # This method starts a new thread to run the script
        self.stop_script = False
        script_thread = threading.Thread(target=self.launch_script)
        script_thread.start()

    def on_key_press(self, key):
        # This method is called when a key is pressed, and it sets the stop_script flag to True if the key pressed is F8
        if key == Key.f8:
            self.stop_script = True



#_ _ _ _ ___  ____ ____ ___ ____ 
#| | | | |  \ | __ |___  |  [__  
#|_|_| | |__/ |__] |___  |  ___] 
                             


# Function record click mouse (double click in program launch)
    def click_widgets(self, row):
        # Create widgets for a "Clic" or "Double clic" action
        x_line_edit = QLineEdit()
        y_line_edit = QLineEdit()
        position_button = QPushButton("Position")
        position_button.clicked.connect(lambda: self.record_mouse_position(x_line_edit, y_line_edit))
        delay_spinbox = self.create_delay_spinbox()

        # Return the widgets as a list
        return [x_line_edit, y_line_edit, position_button, delay_spinbox]




#Function to move the mouse without clicking
    def move_widgets(self, row):
        # Create line edits for x and y coordinates, a button to record the position, and a delay spinbox
        x_line_edit = QLineEdit()
        y_line_edit = QLineEdit()
        position_button = QPushButton("Position")

        position_button.clicked.connect(lambda: self.record_mouse_position(x_line_edit, y_line_edit))
        delay_spinbox = self.create_delay_spinbox()

        return [x_line_edit, y_line_edit, position_button, delay_spinbox]
    






#Function to play a pressed key
    def key_press_widgets(self, row):
        # Create widgets for a "Press" action
        key_dropdown = QComboBox()
        all_keys = [k.name for k in Key] 
        key_dropdown.addItems(all_keys)
        spinbox = QSpinBox()
        spinbox.setValue(1)
        label = QLabel("x")
        delay_spinbox = self.create_delay_spinbox()
        return [key_dropdown, spinbox, label, delay_spinbox]







# Functions to record the scroll position
    def scroll_widgets(self, row):
        # Create spinboxes for positive and negative scroll amounts, a button to record the amount, and a delay spinbox
        scroll_spinbox_positive = QSpinBox()
        scroll_spinbox_positive.setRange(1, 100)
        scroll_spinbox_negative = QSpinBox()
        scroll_spinbox_negative.setRange(-100, -1)
        record_button = QPushButton("Record")
        record_button.setCheckable(True)
        record_button.clicked.connect(lambda: self.record_scroll_amount(record_button, scroll_spinbox_positive, scroll_spinbox_negative))
        delay_spinbox = self.create_delay_spinbox()

        return [scroll_spinbox_positive, scroll_spinbox_negative, record_button, delay_spinbox]
    

    def on_scroll(self, x, y, dx, dy):
        # Listen the scroll
        if self.recording_scroll:
            self.scroll_amount += dy


    def record_scroll_amount(self, record_button, scroll_spinbox_positive, scroll_spinbox_negative):
        # If the record button is checked, start recording mouse scroll events
        if record_button.isChecked():
            record_button.setText("Stop")
            self.recording_scroll = True
            self.scroll_amount = 0
            self.listener = MouseListener(on_scroll=self.on_scroll)
            self.listener.start()

        # If the record button is unchecked, stop recording and update the spinboxes with the recorded scroll amount
        else:
            record_button.setText("Record")
            self.recording_scroll = False
            if self.scroll_amount != 0:
                if self.scroll_amount > 0:
                    scroll_spinbox_positive.setValue(self.scroll_amount)
                    scroll_spinbox_negative.setValue(0)
                else:
                    scroll_spinbox_positive.setValue(0)
                    scroll_spinbox_negative.setValue(self.scroll_amount)
            # Stop the listener and reset the recorded scroll amount
            self.listener.stop()
            self.scroll_amount = 0
 
 
    def update_scroll_spinboxes(self, scroll_spinbox_positive, scroll_spinbox_negative):
        # Update the spinboxes with the recorded scroll amount
        if self.scroll_amount > 0:
            # If the scroll amount is positive, set the positive spinbox to the scroll amount and the negative spinbox to 0
            scroll_spinbox_positive.setValue(self.scroll_amount)
            scroll_spinbox_negative.setValue(0)
            # Start the listener to capture additional scroll events
            self.listener.start()
        else:
            # If the scroll amount is negative, set the negative spinbox to the scroll amount and the positive spinbox to 0
            scroll_spinbox_positive.setValue(0)
            scroll_spinbox_negative.setValue(self.scroll_amount)
            # Update the spinboxes recursively until the scroll amount is zero
            self.update_scroll_spinboxes(scroll_spinbox_positive, scroll_spinbox_negative)






# Function to enter text
    def text_widgets(self, row):
        # Create a line edit widget for the text to be typed
        line_edit = QLineEdit()
        # Create a delay spinbox widget to set the delay after the action
        delay_spinbox = self.create_delay_spinbox()
        # Return the widgets as a list
        return [None,line_edit, None, delay_spinbox]







    def keywords_widgets(self, row):
        # Create a line edit widget for the keywords to be typed
        line_edit = QLineEdit()
        # Create a dropdown widget to choose the separator for multiple keywords
        separator_dropdown = QComboBox()
        separator_dropdown.addItems(["Enter", ",", ".", "-", "_", ";"])
        # Create a delay spinbox widget to set the delay after the action
        delay_spinbox = self.create_delay_spinbox()
        # Return the widgets as a list
        return [separator_dropdown, line_edit, None, delay_spinbox]




# Function to add keys combo
    def combo_widgets(self, row):
        # Create a dropdown widget to choose the combo action
        combo_dropdown = QComboBox()
        combo_dropdown.addItems([
            "Ctrl+C", "Ctrl+V", "Ctrl+X", "Ctrl+Z", "Ctrl+Y",
            "Ctrl+A", "Ctrl+F", "Ctrl+S", "Ctrl+O", "Ctrl+P",
            "Ctrl+T", "Ctrl+W", "Ctrl+N", "Ctrl+R", "Ctrl+U",
            "Ctrl+Shift+T", "Ctrl+Shift+N", "Ctrl+Shift+W", "Ctrl+Alt",
            "Alt+Tab", "Alt+F4", "Alt+Enter", "Alt+Space",
            "Shift+Del", "Shift+Ins", "Shift+Home", "Shift+End",
            "Win+D", "Win+M", "Win+E", "Win+R", "Win+L"
        ])
        # Create two dropdown widgets to choose additional keys
        key1_dropdown = QComboBox()
        key2_dropdown = QComboBox()
        
        # Create lists of all possible keys to add to the dropdowns
        letters = [chr(i) for i in range(ord('a'), ord('z') + 1)]
        digits = [str(i) for i in range(10)]
        symbols = ["`", "~", "!", "@", "#", "$", "%", "^", "&", "*", "(", ")", "-", "_", "=", "+", "[", "{", "]", "}", ";", ":", "'", "\"", ",", "<", ".", ">", "/", "?", "\\", "|"]
        all_keys = [""] + [k.name for k in Key] + letters + digits + symbols
        
        # Add all keys to the dropdowns
        key1_dropdown.addItems(all_keys)
        key2_dropdown.addItems(all_keys)
        # Create a delay spinbox widget to set the delay after the action
        delay_spinbox = self.create_delay_spinbox()
        # Return the widgets as a list
        return [combo_dropdown, key1_dropdown, key2_dropdown, delay_spinbox]




    def wait_widgets(self, row):
        return [None, None, None, self.create_delay_spinbox()]





#_  _ ____ _ _  _    ____ _  _ _  _ ____ ___ _ ____ _  _ ____ 
#|\/| |__| | |\ |    |___ |  | |\ | |     |  | |  | |\ | [__  
#|  | |  | | | \|    |    |__| | \| |___  |  | |__| | \| ___] 


    def string_to_keys(self, key_string):
        # Convert a string representation of keyboard keys to a list of Key objects
        key_list = key_string.split("+")
        keys = []
    
        for key in key_list:
            key = key.strip()
            if not key:
                continue
            if key == "Ctrl":
                keys.append(Key.ctrl)
            elif key == "Shift":
                keys.append(Key.shift)
            elif key == "Alt":
                keys.append(Key.alt)
            elif key == "Win":
                keys.append(Key.cmd)
            else:
                try:
                    keys.append(Key[key])
                except KeyError:
                    keys.append(key.lower())
    
        return keys
    
    
    def release_modifier_keys(self, keyboard_controller):
        # Release all modifier keys (Ctrl, Alt, Shift, and Windows key)
        modifier_keys = [Key.ctrl, Key.alt, Key.shift, Key.cmd]
        for key in modifier_keys:
            keyboard_controller.release(key)    
    
    

    def create_delay_spinbox(self):
        # Create a QDoubleSpinBox widget for entering delays between actions
        delay_spinbox = QDoubleSpinBox()
        delay_spinbox.setRange(0, 60)
        delay_spinbox.setSingleStep(0.1)
        delay_spinbox.setValue(0.1)
        return delay_spinbox
    
    


    
    
    def on_click(self, x, y, button, pressed):
        # Update the stored mouse position when a mouse button is clicked
        if pressed:
            self.mouse_x, self.mouse_y = x, y
            return False  
    
    
    def record_mouse_position(self, x_line_edit, y_line_edit):
        # Record the current mouse position and set the values of the specified line edits to the recorded values
        self.mouse_x, self.mouse_y = None, None
        with mouse.Listener(on_click=self.on_click) as listener:
            listener.join()
        if self.mouse_x is not None and self.mouse_y is not None:
            x_line_edit.setText(str(self.mouse_x))
            y_line_edit.setText(str(self.mouse_y))
    
    
    def clear_table(self):
        def clear_action():
            # Clear all rows from the script table
            self.table.setRowCount(0)

        confirmation_message = "Do you really want to delete everything?"
        self.logger.show_choice(self, confirmation_message, clear_action)

    
    
    def toggle_time_machine(self, state):
        # If the time machine checkbox is checked, update the delay values in the script table based on the time machine factor
        # If the checkbox is unchecked, update the delay values based on the inverse of the time machine factor

        if state == Qt.Checked:
            factor = self.time_machine_spinbox.value() / 100
            self.update_delays(factor)

        else:
            factor = 100 / self.time_machine_spinbox.value()
            self.update_delays(factor)
    
    
    def update_delays(self, factor):
        # Update the delay value for each row in the script table based on the specified factor
        for i in range(self.table.rowCount()):
            delay_spinbox = self.table.cellWidget(i, 4)

            if delay_spinbox is not None:
                delay = delay_spinbox.value() * factor
                delay_spinbox.setValue(delay)
    


#____ ____ _ _ _    ____ ____ ___ _ ____ _  _ ____ 
#|__/ |  | | | |    |__| |     |  | |  | |\ | [__  
#|  \ |__| |_|_|    |  | |___  |  | |__| | \| ___] 
                                                

    def add_row(self):
        # Get the current number of rows in the table
        row = self.table.rowCount()
        # Call add_or_insert_row to add a new row at the end of the table
        self.add_or_insert_row(row)




    def insert_row(self, row):
       # Call add_or_insert_row to insert a new row below the specified row
       self.add_or_insert_row(row + 1)
       
       # Update the row attribute of add buttons in the rows below the newly inserted row
       for r in range(row + 2, self.table.rowCount()):
           add_button = self.table.cellWidget(r, 6)
           if add_button is not None and isinstance(add_button, QPushButton):
               add_button.row = r




    def add_or_insert_row(self, row, skip_update=False):
        # Generate a new unique row ID
        row_id = uuid.uuid4()
        # Add the row ID to the set of row IDs
        self.row_ids.add(row_id)    

        # Insert a new row into the table at the specified position
        self.table.insertRow(row)   

        # Create a dropdown widget to select the action type for the new row
        action_type_dropdown = self._create_action_type_dropdown(row)
        # Set the cell widget for the action type dropdown
        self.table.setCellWidget(row, 0, action_type_dropdown)  

        if not skip_update:
            # Create widgets for the selected action type and add them to the row
            widgets = self.get_widgets_for_action_type(action_type_dropdown.currentText(), row)
            self.add_widgets(row, widgets)  

        # Create a button widget to delete the new row and add it to the table
        delete_button = self._create_delete_button(row_id)
        self.table.setCellWidget(row, 5, delete_button) 

        # Create a button widget to insert a new row below the new row and add it to the table
        add_button = self._create_add_button(row)
        self.table.setCellWidget(row, 6, add_button)    

        # Use QTimer to defer the execution of update_row_widgets
        if not skip_update:
            QTimer.singleShot(0, lambda: self.update_row_widgets(row))  

        # If it's not the first row, copy the previous row's widgets
        if row > 0 and not skip_update:
            self.initialize_row(row - 1, row)




    def initialize_row(self, src_row, dest_row):
        # Iterate through columns 1 to 4
        for col in range(1, 5):  
            # Get widget from corresponding cell of source row
            src_widget = self.table.cellWidget(src_row, col)    

            # Create a new widget based on the type of the source widget
            if src_widget is None:
                # Create new empty QLabel if widget doesn't exist
                new_widget = QLabel("")

            elif isinstance(src_widget, QLineEdit):
                # Create new QLineEdit with same text as source widget
                new_widget = QLineEdit(src_widget.text())

            elif isinstance(src_widget, QComboBox):
                new_widget = QComboBox()
                new_widget.addItems([src_widget.itemText(i) for i in range(src_widget.count())])
                new_widget.setCurrentText(src_widget.currentText())

            elif isinstance(src_widget, QSpinBox):
                new_widget = QSpinBox()
                new_widget.setValue(src_widget.value())

            elif isinstance(src_widget, QDoubleSpinBox):
                new_widget = QDoubleSpinBox()
                new_widget.setValue(src_widget.value())

            else:
                # Create new empty QLabel if widget is of none of the above types
                new_widget = QLabel("") 

            # Place the new widget in the corresponding cell of the destination row
            self.table.setCellWidget(dest_row, col, new_widget) 





    def _create_action_type_dropdown(self, row):
        # Create a dropdown widget for selecting action type
        action_type_dropdown = QComboBox()

        # Add available action types to the dropdown
        action_type_dropdown.addItems(["Clic", "Double clic", "Move", "Press", "Combo", "Scroll", "Text", "Keywords", "Wait"])

        # Connect the currentIndexChanged signal to update the widgets for the row when the action type is changed
        action_type_dropdown.currentIndexChanged.connect(partial(self.update_row_widgets, row))
        return action_type_dropdown




    def _create_delete_button(self, row_id):
        # Create a button widget to delete the row
        delete_button = QPushButton("-")

        # Add the row ID as an attribute to the button so it can be identified when clicked
        delete_button.row_id = row_id
        # Connect the button clicked signal to the delete_row method with the row ID as argument
        delete_button.clicked.connect(lambda: self.delete_row(row_id))
        return delete_button




    def _create_add_button(self, row):
        # Create a button widget to insert a new row below the current row
        add_button = QPushButton("+")
        # Add the row number as an attribute to the button so it can be used in the lambda function
        add_button.row = row
        # Connect the button clicked signal to the insert_row method with the row number as argument
        add_button.clicked.connect(lambda: self.insert_row(add_button.row))
        return add_button



    def get_widgets_for_action_type(self, action_type, row):
        # Map the available action types to their corresponding widget functions
        widgets_map = {
            "Clic": self.click_widgets,
            "Double clic": self.click_widgets,
            "Move": self.move_widgets,
            "Press": self.key_press_widgets,
            "Combo": self.combo_widgets,
            "Scroll": self.scroll_widgets,
            "Text": self.text_widgets,
            "Keywords": self.keywords_widgets,
            "Wait": self.wait_widgets
        }

        # Return the widget list generated by the appropriate widget function based on the action type
        return widgets_map.get(action_type, lambda: None)(row)


    def update_row_widgets(self, row):
        # Get the action type from the action type dropdown widget in the first column
        action_type_widget = self.table.cellWidget(row, 0)
        action_type = action_type_widget.currentText() if action_type_widget is not None and isinstance(action_type_widget, QComboBox) else "Clic"  

        # Get the widgets for the selected action type and update the row with them
        widgets = self.get_widgets_for_action_type(action_type, row)
        self.add_widgets(row, widgets)  


    def add_widgets(self, row, widget_list):
        # Add each widget in the list to the cells in the given row
        for col, widget in enumerate(widget_list):
            # If the widget is None, add an empty QLabel instead
            self.table.setCellWidget(row, col + 1, widget if widget is not None else QLabel(""))    


    def delete_row(self, row_id):
        # Find the row with the specified row_id and remove it from the table
        row = next((row for row in range(self.table.rowCount()) if self.table.cellWidget(row, 5).row_id == row_id), None)
        if row is not None:
            self.table.removeRow(row)
            self.row_ids.remove(row_id) 




#____ ____ _  _ ____    ____ ____    _    ____ ____ ___  
#[__  |__| |  | |___    |  | |__/    |    |  | |__| |  \ 
#___] |  |  \/  |___    |__| |  \    |___ |__| |  | |__/ 
                                                        

    def save_script(self):
        # Open a file dialog to allow the user to select a file to save the script to
        options = QFileDialog.Options()
        options |= QFileDialog.ReadOnly
        file_name, _ = QFileDialog.getSaveFileName(self, "SAVE", "", "Text Files (*.txt);;All Files (*)", options=options)
    
        # If a file name was provided, save the script to the file
        if file_name:
            # If the file name does not end in ".txt", add the extension to the file name
            if not file_name.endswith(".txt"):
                file_name += ".txt"
    
            # Open the file for writing and iterate over each row in the script table, writing the data for each row to the file
            with open(file_name, "w") as file:
                for row in range(self.table.rowCount()):
                    row_data = []
                    for col in range(5):
                        cell_widget = self.table.cellWidget(row, col)
    
                        # If the cell widget is empty or contains an empty label, append an empty string to the row data
                        if cell_widget is None or (isinstance(cell_widget, QLabel) and cell_widget.text() == ""):
                            row_data.append("")
    
                        # If the cell widget is a QLineEdit, append its text value to the row data
                        elif isinstance(cell_widget, QLineEdit):
                            row_data.append(cell_widget.text())
    
                        # If the cell widget is a QComboBox, append its current text value to the row data
                        elif isinstance(cell_widget, QComboBox):
                            row_data.append(cell_widget.currentText())
    
                        # If the cell widget is a QSpinBox or QDoubleSpinBox, append its value as a string to the row data
                        elif isinstance(cell_widget, QSpinBox) or isinstance(cell_widget, QDoubleSpinBox):
                            row_data.append(str(cell_widget.value()))
    
                    # Write the row data to the file as a pipe-delimited string
                    file.write("|".join(row_data) + "\n")
    
    

    def load_script(self):
        # Open a file dialog to allow the user to select a script file to load
        options = QFileDialog.Options()
        options |= QFileDialog.ReadOnly
        file_name, _ = QFileDialog.getOpenFileName(self, "RELOAD", "", "Text Files (*.txt);;All Files (*)", options=options)
    
        # If a file was selected, load the script from the file
        if file_name:
            with open(file_name, "r") as file:
                # Iterate over each line in the file
                for line in file:
                    # Parse the row data from the line
                    row_data = line.strip().split("|")
                    action_type = row_data[0]

                    # Add a new row to the table without resetting widgets
                    self.add_or_insert_row(row=self.table.rowCount(), skip_update=True)
                    row = self.table.rowCount() - 1

                    # Set the action type for the new row
                    self.action_type_dropdown = self.table.cellWidget(row, 0)
                    index = self.action_type_dropdown.findText(action_type)


                    # If the action type from the script is found in the dropdown, set it as the current selection.
                    # Then, update the row's widgets based on the selected action type to ensure proper initialization.
                    if index >= 0:
                        self.action_type_dropdown.setCurrentIndex(index)
                        self.update_row_widgets(row)                       


                    # Set the values for each column in the new row
                    for col, value in enumerate(row_data[1:]):
                        cell_widget = self.table.cellWidget(row, col + 1)

                        if cell_widget is None:
                            continue

                        if isinstance(cell_widget, QLineEdit):
                            cell_widget.setText(value)
                        elif isinstance(cell_widget, QComboBox):
                            cell_widget.setCurrentText(value)
                        elif isinstance(cell_widget, QSpinBox):
                            cell_widget.setValue(int(value))
                        elif isinstance(cell_widget, QDoubleSpinBox):
                            cell_widget.setValue(float(value))




#_    ____ _  _ _  _ ____ _  _ ____ ____ 
#|    |__| |  | |\ | |    |__| |___ |__/ 
#|___ |  | |__| | \| |___ |  | |___ |  \ 
                                           
    
    def launch_script(self):

        with Listener(on_press=self.on_key_press) as listener:
            mouse_controller = MouseController()
            keyboard_controller = KeyboardController()  

            # Determine the number of iterations to perform based on the user input
            loop_count = self.loop_spinbox.value() if not self.loop_checkbox.isChecked() else float('inf')
            iteration = 0   

            # Add a random delay if wanted
            def get_random_delay(delay):
                if self.random_checkbox.isChecked():
                    random_frames = random.randint(0, self.random_spinbox.value())
                    return delay + random_frames / 60  # convert frames in 60fps
                else:
                    return delay    

            # Perform the script for the specified number of iterations or until the stop button is pressed
            while iteration < loop_count and not self.stop_script:
                try:
                    # Iterate over each row in the table and perform the corresponding action
                    for row in range(self.table.rowCount()):
                        if self.stop_script:
                            break   

                        # Determine the action to perform based on the user input
                        action_type = self.table.cellWidget(row, 0).currentText()
                        delay = get_random_delay(self.table.cellWidget(row, 4).value()) 

                        # If the action is a click or double click, determine the coordinates of the click
                        if action_type in ["Clic", "Double clic"]:
                            x = int(self.table.cellWidget(row, 1).text())
                            y = int(self.table.cellWidget(row, 2).text())
                            mouse_controller.position = (x, y)  




                        # Perform left click action
                        if action_type == "Clic":
                            try:
                                mouse_controller.click(Button.left, 1)
                            except Exception as e:
                                self.logger.exception(f"Error in 'Clic' action:  {e}\n\n Thanks to share the error here :\n\n https://github.com/SECRET-GUEST/autoclicker/issues \n\n\n\n")
                                self.logger.show_error(None, f"Error in 'Clic' action: {e} \n\n Please save the commands and share it with the error here :\n\n https://github.com/SECRET-GUEST/autoclicker/issues \n\n\n\n")

                            time.sleep(delay)   




                        # Perform double click action
                        elif action_type == "Double clic":
                            try:
                                mouse_controller.click(Button.left, 2)
                            except Exception as e:
                                self.logger.exception(f"Error in 'Double Clic' action:  {e}\n\n Thanks to share the error here :\n\n https://github.com/SECRET-GUEST/autoclicker/issues \n\n\n\n")
                                self.logger.show_error(None, f"Error in 'Double Clic' action: {e} \n\n Please save the commands and share it with the error here :\n\n https://github.com/SECRET-GUEST/autoclicker/issues \n\n\n\n")

                            time.sleep(delay)   





                        # Perform key press action
                        elif action_type == "Press":
                            try:
                                key_name = self.table.cellWidget(row, 1).currentText()
                                key = getattr(Key, key_name)
                                count = self.table.cellWidget(row, 2).value()   

                                # Press and release the key the specified number of times
                                for _ in range(count):
                                    keyboard_controller.press(key)
                                    keyboard_controller.release(key)
                            except Exception as e:
                                self.logger.exception(f"Error in 'Press' action:  {e}\n\n Thanks to share the error here :\n\n https://github.com/SECRET-GUEST/autoclicker/issues \n\n\n\n")
                                self.logger.show_error(None, f"Error in 'Press' action: {e} \n\n Please save the commands and share it with the error here :\n\n https://github.com/SECRET-GUEST/autoclicker/issues \n\n\n\n")

                            time.sleep(delay)   





                        # Perform mouse move action
                        elif action_type == "Move":
                            try:
                                x = int(self.table.cellWidget(row, 1).text())
                                y = int(self.table.cellWidget(row, 2).text())
                                mouse_controller.position = (x, y)
                            except Exception as e:
                                self.logger.exception(f"Error in 'Move' action:  {e}\n\n Thanks to share the error here :\n\n https://github.com/SECRET-GUEST/autoclicker/issues \n\n\n\n")
                                self.logger.show_error(None, f"Error in 'Move' action: {e} \n\n Please save the commands and share it with the error here :\n\n https://github.com/SECRET-GUEST/autoclicker/issues \n\n\n\n")

                            time.sleep(delay)   





                        # Perform combo key press action
                        elif action_type == "Combo":
                            try:
                                combo_text = self.table.cellWidget(row, 1).currentText()
                                extra_key1_name = self.table.cellWidget(row, 2).currentText()
                                extra_key2_name = self.table.cellWidget(row, 3).currentText()   

                                combo_keys = self.string_to_keys(combo_text)
                                extra_key1 = self.string_to_keys(extra_key1_name)    
                                extra_key2 = self.string_to_keys(extra_key2_name)

                                keys_to_press = combo_keys + extra_key1 + extra_key2

                                # Press and release the keys in the correct order
                                for key in keys_to_press:
                                    keyboard_controller.press(key)
                                time.sleep(0.1)

                                for key in reversed(keys_to_press):
                                    keyboard_controller.release(key)
                            except Exception as e:
                                self.logger.exception(f"Error in 'Combo' action:  {e}\n\n Thanks to share the error here :\n\n https://github.com/SECRET-GUEST/autoclicker/issues \n\n\n\n")
                                self.logger.show_error(None, f"Error in 'Combo' action: {e} \n\n Please save the commands and share it with the error here :\n\n https://github.com/SECRET-GUEST/autoclicker/issues \n\n\n\n")

                            time.sleep(delay)





                        # Perform scroll action
                        elif action_type == "Scroll":
                            try:
                                scroll_amount_positive = self.table.cellWidget(row, 1).value()
                                scroll_amount_negative = self.table.cellWidget(row, 2).value()
                                scroll_amount = scroll_amount_positive + scroll_amount_negative

                                if scroll_amount > 0:
                                    for _ in range(scroll_amount):
                                        mouse_controller.scroll(0, 1)
                                else:
                                    for _ in range(abs(scroll_amount)):
                                        mouse_controller.scroll(0, -1)
                            except Exception as e:
                                self.logger.exception(f"Error in 'Scroll' action:  {e}\n\n Thanks to share the error here :\n\n https://github.com/SECRET-GUEST/autoclicker/issues \n\n\n\n")
                                self.logger.show_error(None, f"Error in 'Scroll' action: {e} \n\n Please save the commands and share it with the error here :\n\n https://github.com/SECRET-GUEST/autoclicker/issues \n\n\n\n")

                            time.sleep(delay)





                        # Perform text typing action
                        elif action_type == "Text":
                            try:
                                text = self.table.cellWidget(row, 2).text()
                                keyboard_controller.type(text)
                            except Exception as e:
                                self.logger.exception(f"Error in 'Text' action:  {e}\n\n Thanks to share the error here :\n\n https://github.com/SECRET-GUEST/autoclicker/issues \n\n\n\n")
                                self.logger.show_error(None, f"Error in 'Text' action: {e} \n\n Please save the commands and share it with the error here :\n\n https://github.com/SECRET-GUEST/autoclicker/issues \n\n\n\n")
                            
                            time.sleep(delay)



                        # Perform keywords typing action
                        elif action_type == "Keywords":
                            try:
                                # Define a function to get the key for a given separator
                                def get_key_for_char(separator):
                                    # Define a dictionary of special characters and their corresponding keys
                                    special_chars = {
                                        ',': ',',
                                        '.': '.',
                                        '-': '-',
                                        '_': '_',
                                        ';': ';',
                                        'Enter': Key.enter
                                    }
                                    # Return the key for the given separator from the dictionary
                                    return special_chars.get(separator)                     

                                # Get the text from the keyword cell and the separator from the dropdown
                                keywords_text = self.table.cellWidget(row, 2).text()
                                separator_widget = self.table.cellWidget(row, 1)
                                if isinstance(separator_widget, QComboBox):
                                    separator = separator_widget.currentText()
                                else:
                                    separator = ","

                                # Replace the separator with the appropriate character
                                if separator == "Enter":
                                    keywords_text = keywords_text.replace(",", "\n")
                                else:
                                    keywords_text = keywords_text.replace(",", separator.strip())

                                # Split the keywords into a list
                                keywords = keywords_text.split(separator)

                                # Get the key to press between keywords
                                key = get_key_for_char(separator)

                                # Type each keyword and press the key between them
                                for i, keyword in enumerate(keywords):
                                    keyword = keyword.strip()

                                    if keyword:
                                        keyboard_controller.type(keyword)
                                        if i < len(keywords) - 1:
                                            if key != Key.enter:
                                                keyboard_controller.press(key)
                                                keyboard_controller.release(key)
                                            else:
                                                keyboard_controller.press(Key.enter)
                                                keyboard_controller.release(Key.enter)
                            except Exception as e:
                                # If an error occurs, log the error and show an error message to the user
                                self.logger.exception(f"Error in 'Keywords' action:  {e}\n\n Thanks to share the error here :\n\n https://github.com/SECRET-GUEST/autoclicker/issues \n\n\n\n")
                                self.logger.show_error(None, f"Error in 'Keywords' action: {e} \n\n Please save the commands and share it with the error here :\n\n https://github.com/SECRET-GUEST/autoclicker/issues \n\n\n\n")

                            # Wait for the specified delay
                            time.sleep(delay)                       




                        # Perform wait action
                        elif action_type == "Wait":
                            time.sleep(delay)


                # Catch any exceptions that occur during script execution and print an error message
                except Exception as e:
                    self.logger.exception(f"Critical error:  {e}\n\n Thanks to share the error here :\n\n https://github.com/SECRET-GUEST/autoclicker/issues \n\n\n\n")
                    self.logger.show_error(None, f"Critical error: {e} \n\n Please save the commands and share it with the error here :\n\n https://github.com/SECRET-GUEST/autoclicker/issues \n\n\n\n")

                
                # Release all keyboard keys at the end of each iteration
                finally:
                    for key in Key:
                        keyboard_controller.release(key)

                    iteration += 1
                    return






#____ ____ ____ ___  _  _ _ ____ ____ _       _  _ ____ ____ ____    _ _  _ ___ ____ ____ ____ ____ ____ ____ 
#| __ |__/ |__| |__] |__| | |    |__| |       |  | [__  |___ |__/    | |\ |  |  |___ |__/ |___ |__| |    |___ 
#|__] |  \ |  | |    |  | | |___ |  | |___    |__| ___] |___ |  \    | | \|  |  |___ |  \ |    |  | |___ |___ 
                                                                                                             

    def GUI(self):
        self.setWindowTitle("🥺 Lemme do it 4 U 🥺")

        self.main_widget = QWidget()
        self.setCentralWidget(self.main_widget)


        #The button of the app

        self.btn_save_script = QPushButton("SAVE")
        self.btn_save_script.clicked.connect(self.save_script)
        self.btn_save_script.setToolTip("Save the current tables")

        self.btn_load_script = QPushButton("RELOAD")
        self.btn_load_script.clicked.connect(self.load_script)
        self.btn_load_script.setToolTip("Add an old table to the current one")


        self.table = QTableWidget()
        self.table.setColumnCount(7)
        self.table.setHorizontalHeaderLabels(["Type", "Action", "Text", "Position", "Delay", "Delete", "Add"])

        self.btn_add_row = QPushButton("ADD A NEW ROW IN TABLE")
        self.btn_add_row.clicked.connect(self.add_row)
        self.btn_add_row.setToolTip("Add new row")

        self.time_machine_checkbox = QCheckBox("Time machine modulator")
        self.time_machine_checkbox.setToolTip("Change the time delay for all tables.")
        self.time_machine_spinbox = QSpinBox()
        self.time_machine_spinbox.setToolTip("Change the time delay for all tables.")

        # Set the range of the time machine spin box to 1-1000
        self.time_machine_spinbox.setRange(1, 1000)

        #Set the initial value of the time machine spin box to 100%
        self.time_machine_spinbox.setValue(100)
        self.time_machine_spinbox.setSuffix("%")
        self.time_machine_checkbox.stateChanged.connect(self.toggle_time_machine)

        # Connect the valueChanged signal of the time machine spin box to a lambda function that toggles the time machine checkbox
        self.time_machine_spinbox.valueChanged.connect(lambda value: self.toggle_time_machine(Qt.Checked if self.time_machine_checkbox.isChecked() else Qt.Unchecked))


        self.btn_sacrifice = QPushButton("Sacrifice all")
        self.btn_sacrifice.clicked.connect(self.clear_table)
        self.btn_sacrifice.setToolTip("Delete all tables")

        self.loop_checkbox = QCheckBox("Reach Infinity > F8 < to exit, or loop")
        self.loop_checkbox.setToolTip("Replay the loop until end of time")

        self.loop_spinbox = QSpinBox()
        self.loop_spinbox.setToolTip("Choose a number of loopings")
        self.loop_spinbox.setRange(1, 999999999)
        self.loop_spinbox.setValue(1)


        self.random_checkbox = QCheckBox("Nanosecond entropy injector")
        self.random_checkbox.setToolTip("Add random time delay between each action")
        self.random_spinbox = QSpinBox()
        self.random_spinbox.setRange(0, 999999999)
        self.random_spinbox.setValue(0)
        self.random_spinbox.setToolTip("Add random time delay between each action")


        self.launch_script_button = QPushButton("F I N I S H   H I T !")
        self.launch_script_button.clicked.connect(self.launch_script_thread)
        self.launch_script_button.setToolTip("FATALITY")


        # Layout instructions
        self.Vlay_BMO = QVBoxLayout()
        self.Hlay_BMO = QHBoxLayout()
        self.Hlay_live_or_die = QHBoxLayout()
        self.Hlay_BMO_loop = QHBoxLayout()
        self.Hlay_BMO_time_machine = QHBoxLayout()
        self.Hlay_random_delay = QHBoxLayout()

        self.main_widget.setLayout(self.Vlay_BMO)

        self.Vlay_BMO.addLayout(self.Hlay_BMO)
        self.Hlay_BMO.addWidget(self.btn_save_script)
        self.Hlay_BMO.addWidget(self.btn_load_script)

        self.Vlay_BMO.addWidget(self.table)

        self.Vlay_BMO.addLayout(self.Hlay_live_or_die)
        self.Hlay_live_or_die.addWidget(self.btn_add_row)
        self.Hlay_live_or_die.addWidget(self.btn_sacrifice)

        self.Vlay_BMO.addSpacing(10)
        self.Vlay_BMO.addLayout(self.Hlay_BMO_time_machine)
        self.Hlay_BMO_time_machine.addWidget(self.time_machine_checkbox)
        self.Hlay_BMO_time_machine.addWidget(self.time_machine_spinbox)


        self.Vlay_BMO.addSpacing(10)
        self.Vlay_BMO.addLayout(self.Hlay_BMO_loop)
        self.Hlay_BMO_loop.addWidget(self.loop_checkbox)
        self.Hlay_BMO_loop.addWidget(self.loop_spinbox)
        self.Hlay_BMO_loop.addItem(QSpacerItem(0, 0, QSizePolicy.Expanding, QSizePolicy.Minimum))

        self.Vlay_BMO.addSpacing(10)
        self.Vlay_BMO.addLayout(self.Hlay_random_delay)
        self.Hlay_random_delay.addWidget(self.random_checkbox)
        self.Hlay_random_delay.addWidget(self.random_spinbox)

        self.Vlay_BMO.addSpacing(20)
        self.Vlay_BMO.addWidget(self.launch_script_button)



#____ ____ ____ _  _ ____ ___    _    ____ _  _ _  _ ____ _  _
#|__/ |  | |    |_/  |___  |     |    |__| |  | |\ | |    |__|
#|  \ |__| |___ | \_ |___  |     |___ |  | |__| | \| |___ |  |
                
#ENDING | https://www.youtube.com/watch?v=CgZVrvQZB6U&ab_channel=SECRETGUEST :3



# __name__ == "__main__":
#    app = QApplication(sys.argv)
#
#    mainWin = DarthBMO()
#    mainWin.show()
#
#    sys.exit(app.exec_())