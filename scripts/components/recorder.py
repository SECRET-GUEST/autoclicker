
#         ████████     ██████
#        █░░░░░░░░██_██░░░░░░█
#       █░░░░░░░░░░░█░░░░░░░░░█
#      █░░░░░░░███░░░█░░░░░░░░░█
#      █░░░░███░░░███░█░░░████░█
#    █░░░██░░░░░░░░███░██░░░░██
#   █░░░░░░░░░░░░░░░░░█░░░░░░░░███
#   █░░░░░░░░░░░░░██████░░░░░████░░█
#   █░░░░░░░░░█████░░░████░░██░░██░░█
#  ██░░░░░░░███░░░░░░░░░░█░░░░░░░░███
# █░░░░░░░░░░░░░░█████████░░█████████
#█░░░░░░░░░░█████ ████   ████ █████ █
#█░░░░░░░░░░█      █ ███   █   ███ █ █
#█░░░░░░░░░░░░█   ████ ████    ██ ████
#░░░░░░░░░░░░░█████████░░░████████░░░█
#░░░░░░░░░░░░░░░░█░░░░░█░░░░░░░░░░░░█
#░░░░░░░░░░░░░░░░░░░░██░░░░█░░░░░░██
#░░░░░░░░░░░░░░░░░░██░░░░░░░███████
#░░░░░░░░░░░░░░░░██░░░░░░░░░░█░░░░░█                                            _____                                 _____                                            _____                                                   _____
#░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░█                                          /\    \                               /\    \                                          /\    \                                                 /\    \
#░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░█                      ::                 /::\    \                             /::\    \                                        /::\____\                                               /::\____\
#░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░█                                        /::::\    \                           /::::\    \           :::         ::           ::: ::/    /                         :                   :: ::/    /
#░░░░░░░░░░░█████████░░░░░░░░░░░░░░██                                       /::::::\    \                         /::::::\    \                               ::: : :::/    /                                              /:::/    /
#░░░░░░░░░░█▒▒▒▒▒▒▒▒███████████████▒▒█                                     /:::/\:::\    \                    :: ::::/\:::\    \                                  /:::/    /                                              /:::/    /
#░░░░░░░░░█▒▒███████▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒█                                    /:::/__\:::\    \                     /:::/__\:::\    \                                /:::/    /                                            :::: :/____/
#░░░░░░░░░█▒▒▒█▓▓▓▓██████████████████                                    /::::\   \:::\    \                   /::::\   \:::\    \                              /:::/    /                                              /::::\    \
#░░░░░░░░░██▒▒█▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█                                       /::::::\   \:::\    \                 /::::::\   \:::\    \                            /:       /      _____                                   /::::::\    \   _____
#░░░░░░░░░░█▒▒█▓█████████████████ ████                                 /:::/\:::\   \:::\ ___\               /:::/\:::\   \:::\____\                          /:::/____/      /\    \                                 /:::/\:::\    \ /\    \
#░░░░░░░░░░█▒▒██▓▓▒▓▒▓▒▓▒▒▒▒▒▒▒▒▓█▓▒▒▒█                               /:::/__\:::\   \:::|    |             /:::/  \:::\   \:::|    |                         :::|    /      /::\____\                        ::::::: :::/ : :::\    /::\____\
#░░░░░░░░░█▒▒████████▓▒███▓██▒▒▒▒▒▒▒▒▒█                  :            \:::\   \:::\  /:::|____|             \::/   |::::\  /:::|____|                      : :: :|____\     /:::/    /                               \::/    \:::\: ::::/    /
#░░░░░░░░░█▒▒▒▒▒▒▒▒▒█████████████▓█▓██                                 \:::\   \:::\/:::/    /               \/____|:::::\/:::/    /                          \:::\    \   /:::/    /                                 \/____/: :::\/:::/    /
#░░░░░░░░░░████████▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒█                                  \:::\   \::::::/    /                      |:::::::::/    /                            \:::\   :: : ::/    /                                 :  :  : : :::::::/    /
#░░░░░░░░░░░░░░░░░░██████████████████                                    \:::\   \::::/    /          :  :         |::|\::::/    /           ::                 \:::\    /:::/    /               ::::                          \::       /
#░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░█            ::                           \:::\  /:::/    /                      :: ::| \::/____/                                \:::\__/:::/    /                                              /:::/    /
#██░░░░░░░░░░░░░░░░░░░░░░░░░░░██                                           \:::\/:::/    /                         |::|  ~|                                       \::::::::/    /                                             : :::/    /
#▓██░░░░░░░░░░░░░░░░░░░░░░░░██                                              \::::::/    /                          |::|   |                                        \::::::/    /                                              /:::/    /
#▓▓▓███░░░░░░░░░░░░░░░░░░░░█                                                 \::::/    /                           \::|   |                                         \::::/    /                              ::: :           /:::/    /
#▓▓▓▓▓▓███░░░░░░░░░░░░░░░██                                 :                 \::/____/            :                \:|   |               :    ::::                  \::/____/                                               \::/    /
#▓▓▓▓▓▓▓▓▓███████████████▓▓█                                                   ⠋                                     \|___|                                           ⠩                                                      \/____/
#▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓██
#▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█                                                                                                                                                                                                                                               |                                                                    |                                      |
#▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█                                                                    |                                                                                                             |
#______________________________                                                                                                                       |                                                                                                                      |                                                                                                                                              |                    |
#___________________________
#_ ______ _____ _________
#/            /                                                         |                                |                       |                    |                |                       |                    |                |                       |                    |                     |                       |                    |
                
#       \                          |                                |                                               |  |                                          |                    |                                          |                       |                    |  |                                           |                    |        |                    |                              |
                

#     |               |                                 |
                
#                 |                                                |            |                                   |                               |                           |                               |                           |                               |                                |                               |
#          |                                  |                                     |
                
#                 |                     |                                                     |                                   |                               |     |                                   |                               |     |                                   |                               |          |                                   |                               |
#  |                          |                       |                    |
#          |                                    |                                         |     |                    |                                    | |     |                    |                                    | |     |                    |                                    |      |     |                                                        |
#     |                        |                                 |      |                                |                       |                    |                |                       |                    |                |                       |                    |                     |                       |                    |
                
#                     |                                                |      |                                   |                               |                         |                               |                         |                               |                              |                               |
#          |                                   |                               |                   |                                |                       |                    |          |                                |                       |                    |          |                                |                       |                    |               |                                |                                        |
                
#                 |                     |
#  |                                |                       |                    |            |                                |                       |                    |     |                                |                       |                    |     |                                |                       |                              |                                |
#          |                               |                                         |                              |                       |                    |                           |                       |                    |                           |                       |                    |                                |                       |                    |
                
#  |         |                                   PRESENTATION                                                |                                |                    |   |                                |                    |   |                                |                    |        |                                |                    |
#                                                                                                                              |                               |     |                                   |                               |     |                                   |                               |          |                                   |                               |
#               |                             /                 \                          |                                                                              |                               |     |                                   |                               |     |                                   |                               |          |                                   |                               |
                
#       |                              Simple autoclicker / recorder                     |                                           |               |                                           |               |                                           |                    |                                           |
                
#                          /                      |    v    |                    \
                
#                    able to record and repeat all click, combos, scroll or key pressed        |                                |                                          |      |                                |                                          |      |                                |                                          |           |                                |  
#     |                  !      |                                   |     |                                |                       |                    |                |                       |                    |                |                       |                    |                    |                                           |
#                               |                                   |     |                  
#                  |            |                   Anyway          !                        |                                         |                                |                       |                    |                |                       |                    |                |                       |                    |                    |
                
#             |                      |                 have                                                 |                        |                                         |                                |                       |                    |                |                       |                    |                |                       |                    |                     |                                           |
                

#                |                                  FUN         |                        |                                         |                                |                       |                    |                |                       |                    |                |                       |                    |                    |                                                                      |
                
#                                                        =)
                
#
#                               |                      or                                       |                                                            |                    |                |                       |                    |                |                       |                    |                    |                                           |
                

#             |                              |       DIE ! ! !        |                       |                            |                |                       |                    |                |                       |                    |                    |                                           |#     |                        |                                         |                                |
                
#
#                                                    !                                       |                                |                    |  |                                |                    |  |                                |                    |       |                                |                    |
                
#     |               |                                 !
                
#                 |                                                |            |                                   |                               |                           |                               |                           |                               |                                |                               |
#          |                                  !                                     |
                
#                 |                     |                                                     |                                   |                               |     |                                   |                               |     |                                   |                               |          |                                   |                               |
#  |                          |                       |                    !
#          |                                    |                                         |     |                    |                                    | |     |                    |                                    | |     |                    |                                    |      |     |                    |                                    |
#     |                        |                                 |      |                                |                       |                    |                |                       |                    |                |                       |                    |                    |                                           |
                
#                     |                                                |      |                                   |                               |                         |                               |                         |                               |                              |                               |
#          |                                   |                               |                   |                                |                       |                    |          |                                |                       |                    |          |                                |                       |                    |               |                                                                |
                
#                 |                     |
#  |                                |                       |                    |            |                                |                       |                    |     |                                |                       |                    |                                    |                       |                              |                                                                        |
#          |                               |                                         !                              |                       |                    |                           |                       |                    |                           |                       |                    |                                |                       |                    |
                
#_ _  _ ____ ___ ____ _    _    ____ ___ _ ____ _  _
#| |\ | [__   |  |__| |    |    |__|  |  | |  | |\ |
#| | \| ___]  |  |  | |___ |___ |  |  |  | |__| | \|
         

import time

from PyQt5.QtWidgets import QWidget, QPushButton, QVBoxLayout, QSlider, QHBoxLayout, QLabel, QTextEdit
from PyQt5.QtCore import Qt
from PyQt5 import QtGui

from pynput import mouse, keyboard

#___  ____ _ _ _ ____ ____    ___  _    ____ _  _ ___
#|__] |  | | | | |___ |__/    |__] |    |__| |\ |  |
#|    |__| |_|_| |___ |  \    |    |___ |  | | \|  |
                

#OPENING | https://www.youtube.com/watch?v=_85LaeTCtV8 :3


#Our importable class containing functions to avoid working too hard
class HardWorkingBruh(QWidget):
    def __init__(self, logger):
        super().__init__()

        #Error handler 
        self.logger = logger

        #List to store mouse events
        self.mouse_events = []

        #List to store keyboard events
        self.keyboard_events = []

        self.f_key_handled = False

        #Dictionary to store the state of modifier keys
        self.modifier_keys = {
            'ctrl_left': False,
            'ctrl_right': False,
            'alt_left': False,
            'alt_right': False,
            'shift_left': False,
            'shift_right': False,
        }

        #Variables to store keyboard and mouse listeners
        self.keyboard_listener = None
        self.mouse_listener = None

        #Recording state of mouse events (True if recording, False otherwise)
        self.recording = False

        #Repeating state of mouse events (True if repeating, False otherwise)
        self.repeating = False
        
        #On finit par lancer l'interface utilisateur
        self.GUI()






#____ _  _ ___ ____ ____ _    _ ____ _  _ ____ ____ 
#|__| |  |  |  |  | |    |    | |    |_/  |___ |__/ 
#|  | |__|  |  |__| |___ |___ | |___ | \_ |___ |  \ 
     
                                           
#Now we define our main functions:

#Function to record clicks
    def on_click(self, x, y, button, pressed):
        #If recording is not active, do nothing
        if not self.recording:
            return

        #Creates a tuple with information about the click event and adds it to the list of events
        event = ('click', time.time(), x, y, button, pressed)
        self.mouse_events.append(event)
        self.log_message(str(event))



#Function to record scrolling
    def on_scroll(self, x, y, dx, dy):
        #If recording is not active, do nothing
        if not self.recording:
            return

        event = ('scroll', time.time(), x, y, dx, dy)
        self.mouse_events.append(event)
        self.log_message(str(event))



#Function for displaying information at the top of the list (with 0)
    def log_message(self, message):
        self.on_air.moveCursor(QtGui.QTextCursor.Start)
        self.on_air.insertPlainText(message + "\n")
        self.on_air.moveCursor(QtGui.QTextCursor.Start)



    # Function to record keyboard events
    def on_key_press(self, key):
        if not self.recording:
            return

        # Prevent recording certain keys and record combinations with ctrl, alt, ...
        if key not in {keyboard.Key.f1, keyboard.Key.f2, keyboard.Key.f3, keyboard.Key.f4, keyboard.Key.f6, keyboard.Key.f9, keyboard.Key.f10, keyboard.Key.f11}:
            if key in {keyboard.Key.ctrl_l, keyboard.Key.ctrl_r, keyboard.Key.alt_l, keyboard.Key.alt_r, keyboard.Key.shift_l, keyboard.Key.shift_r}:

                # Convert the 'key' object to a string, then split the string using "." to separate, get the 2nd element [1]
                # For example: if the string is 'Key.ctrl + l', 'ctrl_l' will be retrieved.
                # Then, update the 'modifier_keys' dictionary by assigning the value True to the corresponding key.
                # This means that the 'modifier' key is currently pressed.
                self.modifier_keys[str(key).split('.')[1]] = True

            # Create a tuple representing the key press event with:
            # key: the key
            # time.time(): the timestamp of the event in seconds
            # 2nd key: the pressed key
            # True: pressed (False if released)
            # self.modifier_keys.copy(): a copy of the 'modifier_keys' dictionary representing the state of the modifiers (ctrl, ...)
            event = ('key', time.time(), key, True, self.modifier_keys.copy())

            # Add to the 'keyboard_events' list
            self.keyboard_events.append(event)
            self.log_message(str(event))




#Function to handle key release events
    def on_key_release(self, key):
        if not self.recording:
            return

        if key not in {keyboard.Key.f1, keyboard.Key.f2, keyboard.Key.f3, keyboard.Key.f4, keyboard.Key.f6, keyboard.Key.f9, keyboard.Key.f10, keyboard.Key.f11}:
            if key in {keyboard.Key.ctrl_l, keyboard.Key.ctrl_r, keyboard.Key.alt_l, keyboard.Key.alt_r, keyboard.Key.shift_l, keyboard.Key.shift_r}:
                self.modifier_keys[str(key).split('.')[1]] = False

            event = ('key', time.time(), key, False, self.modifier_keys.copy())
            self.keyboard_events.append(event)
            self.log_message(str(event))


#Function to start recording events
    def start_recording(self):
        self.log_message("Start recording" )
        self.recording = True
        self.mouse_listener = mouse.Listener(on_click=self.on_click, on_scroll=self.on_scroll)
        self.mouse_listener.start()


#Function to stop recording events
    def stop_recording(self) :
        self.log_message( "Stop recording")
        self.recording = False

        if self.mouse_listener:
            self.mouse_listener.stop()


#Function to stop the event repetition loop
    def stop_loop(self):
        self.log_message("Stop loop")
        self.repeating = False


#Resets mouse events
    def reset_events(self):
        self.log_message("Reset events")
        self.mouse_events = []
        self.keyboard_events = []



# Function to replay recorded events
    def play_events(self):
        try:
            self.log_message("Read events")

            if not self.mouse_events and not self.keyboard_events:
                return

            self.repeating = True

            # Get the slider value and convert it to delay (in milliseconds)
            slider_value = self.speeder.value()
            delay = (100 - slider_value) / 100.0

            # Sort the events by their timestamp
            sorted_events = sorted(self.mouse_events + self.keyboard_events, key=lambda x: x[1])

            # Loop while the 'repeating' variable is True
            while self.repeating:
                # Iterate over all recorded mouse and keyboard events
                for event in sorted_events:
                    # If 'repeating' is set to False, break the loop
                    if not self.repeating:
                        break

                    try:
                        # If the event is a mouse click
                        if event[0] == 'click':
                            _, _, x, y, button, pressed = event

                            # Move the cursor to the position (x, y)
                            mouse.Controller().position = (x, y)
                            # If the button is pressed, press the mouse button
                            if pressed:
                                mouse.Controller().press(button)
                            # Otherwise, release the mouse button
                            else:
                                mouse.Controller().release(button)

                        # If the event is a scroll event
                        elif event[0] == 'scroll':
                            _, _, x, y, dx, dy = event

                            mouse.Controller().position = (x, y)
                            mouse.Controller().scroll(dx, dy)

                        # If the event is a keyboard event
                        elif event[0] == 'key':
                            _, _, key, pressed, modifiers = event

                            # If the key is pressed, press the modifier keys and the main key
                            if pressed:
                                for modifier, is_pressed in modifiers.items():
                                    if is_pressed:
                                        keyboard.Controller().press(getattr(keyboard.Key, modifier))

                                keyboard.Controller().press(key)

                            # Otherwise, release the modifier keys and the main key
                            else:
                                keyboard.Controller().release(key)

                                for modifier, is_pressed in modifiers.items():
                                    if is_pressed:
                                        keyboard.Controller().release(getattr(keyboard.Key, modifier))

                    except Exception as e:
                        self.logger.exception(f"Error while processing event:  {e}\n\n Thanks to share the error here :\n\n https://github.com/SECRET-GUEST/autoclicker/issues \n\n\n\n")
                        self.logger.show_error(None, f"Error while processing event: {e} \n\n Please save the commands and share it with the error here :\n\n https://github.com/SECRET-GUEST/autoclicker/issues \n\n\n\n")

                    # Add a delay between events based on the slider value
                    time.sleep(delay)

        except Exception as e:
                    self.logger.exception(f"Critical error:  {e}\n\n Thanks to share the error here :\n\n https://github.com/SECRET-GUEST/autoclicker/issues \n\n\n\n")
                    self.logger.show_error(None, f"Critical error: {e} \n\n Please save the commands and share it with the error here :\n\n https://github.com/SECRET-GUEST/autoclicker/issues \n\n\n\n")

        finally:
            # Release all keys and mouse buttons
            if key is not None:
                keyboard.Controller().release(key)

            # You can add here the release of mouse buttons
            mouse.Controller().release(mouse.Button.left)
            mouse.Controller().release(mouse.Button.right)
            mouse.Controller().release(mouse.Button.middle)

            return




#____ ____ ____ ___  _  _ _ ____ ____ _       _  _ ____ ____ ____    _ _  _ ___ ____ ____ ____ ____ ____ ____ 
#| __ |__/ |__| |__] |__| | |    |__| |       |  | [__  |___ |__/    | |\ |  |  |___ |__/ |___ |__| |    |___ 
#|__] |  \ |  | |    |  | | |___ |  | |___    |__| ___] |___ |  \    | | \|  |  |___ |  \ |    |  | |___ |___ 
   

    def GUI(self):
        self.setWindowTitle('Hard working Bruh')

        # UI buttons
        self.btn_start = QPushButton('START RECORDING (F7)', self)
        self.btn_start.clicked.connect(self.start_recording)

        self.btn_stop = QPushButton('STOP RECORDING (F7)', self)
        self.btn_stop.clicked.connect(self.stop_recording)

        self.btn_play = QPushButton('PLAY', self)
        self.btn_play.clicked.connect(self.play_events)

        self.btn_stop_loop = QPushButton('STOP LOOP (F8)', self)
        self.btn_stop_loop.clicked.connect(self.stop_loop)

        self.btn_reset = QPushButton('RESET ALL EVENTS', self)
        self.btn_reset.clicked.connect(self.reset_events)
        self.btn_reset.setToolTip("reset all events")


        # Create a horizontal slider with a range from 0 to 100
        self.speeder = QSlider(Qt.Horizontal)
        self.speeder.setMinimum(0)
        self.speeder.setMaximum(100)
        self.speeder.setValue(50)

        # Create labels for the slider
        self.lab_speeder = QLabel('SPEED')
        self.lab_min = QLabel('-')
        self.lab_max = QLabel('+')

        # Display the label defining the actions
        self.on_air = QTextEdit(self,objectName="TextEdit")
        self.on_air.setPlainText("\n\nTUTORIAL:\n\nZoom (ctrl + scroll or +/-) works throughout the application\n\nPressed buttons and software actions will be displayed here\n\nYou can increase the repetition rate by adjusting the click speed scrollbar\n\nAs it is not entirely stable, you may encounter errors, but nothing critical. Just restart the computer if it really goes haywire.")
        self.on_air.setReadOnly(True)

        # Create a horizontal layout for the slider and labels
        self.h_lay_ac = QHBoxLayout()
        self.h_lay_ac.addWidget(self.lab_min)
        self.h_lay_ac.addWidget(self.speeder)
        self.h_lay_ac.addWidget(self.lab_max)

        # Create a vertical layout for the buttons, slider and label
        self.v_lay_ac = QVBoxLayout()
        self.v_lay_ac.addWidget(self.btn_start)
        self.v_lay_ac.addWidget(self.btn_stop)
        self.v_lay_ac.addWidget(self.btn_play)
        self.v_lay_ac.addWidget(self.btn_stop_loop)
        self.v_lay_ac.addWidget(self.btn_reset)
        self.v_lay_ac.addWidget(self.lab_speeder)
        self.v_lay_ac.addLayout(self.h_lay_ac)
        self.v_lay_ac.addWidget(self.on_air)

        # Apply the vertical layout
        self.setLayout(self.v_lay_ac)

    #    self.show()




#____ ____ ____ _  _ ____ ___    _    ____ _  _ _  _ ____ _  _
#|__/ |  | |    |_/  |___  |     |    |__| |  | |\ | |    |__|
#|  \ |__| |___ | \_ |___  |     |___ |  | |__| | \| |___ |  |
                
#ENDING | https://www.youtube.com/watch?v=CgZVrvQZB6U&ab_channel=SECRETGUEST :3


#This function defines a class Recorder that allows recording and playing back key presses using the HardWorkingBruh class. 
# It sets up a listener for key press and release events, and adds an instance of HardWorkingBruh to the Recorder widget.

class Recorder(QWidget):
    def __init__(self,logger):
        super().__init__()

        
        #Error handler 
        self.logger = logger
        self.bruh = HardWorkingBruh(logger)
        
        self.main_window = None
        self.VLay_l_recorder = QVBoxLayout()
        self.setLayout(self.VLay_l_recorder)

    def set_main_window(self, main_window):
        self.main_window = main_window

    def start_recording(self):
        ex = self.bruh 


        #Function to handle key press events, if F7 is pressed during recording it will stop and opposite is also true
        def handle_key_press(key):
            if key == keyboard.Key.f7:
                if ex.recording:
                    ex.stop_recording()
                else:
                    ex.start_recording()

            #If any other key is pressed, call the 'on_key_press' method of the 'ex' instance of HardWorkingBruh
            else:
                ex.on_key_press(key)

        #Function to handle key release events
        def handle_key_release(key):
            if key == keyboard.Key.f8:
                ex.stop_loop()
            else:
                ex.on_key_release(key)

        #Put the keyboard on listen to intercept key press and release events
        keyboard_listener = keyboard.Listener(on_press=handle_key_press, on_release=handle_key_release)

        #Start listening
        keyboard_listener.start()

        #Add the instance of HardWorkingBruh to the Recorder widget
        self.VLay_l_recorder.addWidget(ex)


#Finally, we start the event loop
# if __name__ == '__main__':
#     app = QApplication(sys.argv)
#     Recorder()
#     sys.exit(app.exec_())
# 