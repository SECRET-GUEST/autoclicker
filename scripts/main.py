#         ████████     ██████
#        █░░░░░░░░██_██░░░░░░█
#       █░░░░░░░░░░░█░░░░░░░░░█
#      █░░░░░░░███░░░█░░░░░░░░░█
#      █░░░░███░░░███░█░░░████░█
#    █░░░██░░░░░░░░███░██░░░░██
#   █░░░░░░░░░░░░░░░░░█░░░░░░░░███
#   █░░░░░░░░░░░░░██████░░░░░████░░█
#   █░░░░░░░░░█████░░░████░░██░░██░░█
#  ██░░░░░░░███░░░░░░░░░░█░░░░░░░░███
# █░░░░░░░░░░░░░░█████████░░█████████
#█░░░░░░░░░░█████ ████   ████ █████ █
#█░░░░░░░░░░█      █ ███   █   ███ █ █
#█░░░░░░░░░░░░█   ████ ████    ██ ████
#░░░░░░░░░░░░░█████████░░░████████░░░█
#░░░░░░░░░░░░░░░░█░░░░░█░░░░░░░░░░░░█
#░░░░░░░░░░░░░░░░░░░░██░░░░█░░░░░░██
#░░░░░░░░░░░░░░░░░░██░░░░░░░███████
#░░░░░░░░░░░░░░░░██░░░░░░░░░░█░░░░░█                                            _____                                 _____                                            _____                                                   _____
#░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░█                                          /\    \                               /\    \                                          /\    \                                                 /\    \
#░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░█                      ::                 /::\    \                             /::\    \                                        /::\____\                                               /::\____\
#░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░█                                        /::::\    \                           /::::\    \           :::         ::           ::: ::/    /                         :                   :: ::/    /
#░░░░░░░░░░░█████████░░░░░░░░░░░░░░██                                       /::::::\    \                         /::::::\    \                               ::: : :::/    /                                              /:::/    /
#░░░░░░░░░░█▒▒▒▒▒▒▒▒███████████████▒▒█                                     /:::/\:::\    \                    :: ::::/\:::\    \                                  /:::/    /                                              /:::/    /
#░░░░░░░░░█▒▒███████▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒█                                    /:::/__\:::\    \                     /:::/__\:::\    \                                /:::/    /                                            :::: :/____/
#░░░░░░░░░█▒▒▒█▓▓▓▓██████████████████                                    /::::\   \:::\    \                   /::::\   \:::\    \                              /:::/    /                                              /::::\    \
#░░░░░░░░░██▒▒█▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█                                       /::::::\   \:::\    \                 /::::::\   \:::\    \                            /:       /      _____                                   /::::::\    \   _____
#░░░░░░░░░░█▒▒█▓█████████████████ ████                                 /:::/\:::\   \:::\ ___\               /:::/\:::\   \:::\____\                          /:::/____/      /\    \                                 /:::/\:::\    \ /\    \
#░░░░░░░░░░█▒▒██▓▓▒▓▒▓▒▓▒▒▒▒▒▒▒▒▓█▓▒▒▒█                               /:::/__\:::\   \:::|    |             /:::/  \:::\   \:::|    |                         :::|    /      /::\____\                        ::::::: :::/ : :::\    /::\____\
#░░░░░░░░░█▒▒████████▓▒███▓██▒▒▒▒▒▒▒▒▒█                  :            \:::\   \:::\  /:::|____|             \::/   |::::\  /:::|____|                      : :: :|____\     /:::/    /                               \::/    \:::\: ::::/    /
#░░░░░░░░░█▒▒▒▒▒▒▒▒▒█████████████▓█▓██                                 \:::\   \:::\/:::/    /               \/____|:::::\/:::/    /                          \:::\    \   /:::/    /                                 \/____/: :::\/:::/    /
#░░░░░░░░░░████████▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒█                                  \:::\   \::::::/    /                      |:::::::::/    /                            \:::\   :: : ::/    /                                 :  :  : : :::::::/    /
#░░░░░░░░░░░░░░░░░░██████████████████                                    \:::\   \::::/    /          :  :         |::|\::::/    /           ::                 \:::\    /:::/    /               ::::                          \::       /
#░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░█            ::                           \:::\  /:::/    /                      :: ::| \::/____/                                \:::\__/:::/    /                                              /:::/    /
#██░░░░░░░░░░░░░░░░░░░░░░░░░░░██                                           \:::\/:::/    /                         |::|  ~|                                       \::::::::/    /                                             : :::/    /
#▓██░░░░░░░░░░░░░░░░░░░░░░░░██                                              \::::::/    /                          |::|   |                                        \::::::/    /                                              /:::/    /
#▓▓▓███░░░░░░░░░░░░░░░░░░░░█                                                 \::::/    /                           \::|   |                                         \::::/    /                              ::: :           /:::/    /
#▓▓▓▓▓▓███░░░░░░░░░░░░░░░██                                 :                 \::/____/            :                \:|   |               :    ::::                  \::/____/                                               \::/    /
#▓▓▓▓▓▓▓▓▓███████████████▓▓█                                                   ⠋                                     \|___|                                           ⠩                                                      \/____/
#▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓██
#▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█                                                                                                                                                                                                                                               |                                                                    |                                      |
#▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█                                                                    |                                                                                                             |
#______________________________                                                                                                                       |                                                                                                                      |                                                                                                                                              |                    |
#___________________________
#_ ______ _____ _________
#/            /                                                         |                                |                       |                    |                |                       |                    |                |                       |                    |                     |                       |                    |
                
#       \                          |                                |                                               |  |                                          |                    |                                          |                       |                    |  |                                           |                    |        |                    |                              |
                

#     |               |                                 |
                
#                 |                                                |            |                                   |                               |                           |                               |                           |                               |                                |                               |
#          |                                  |                                     |
                
#                 |                     |                                                     |                                   |                               |     |                                   |                               |     |                                   |                               |          |                                   |                               |
#  |                          |                       |                    |
#          |                                    |                                         |     |                    |                                    | |     |                    |                                    | |     |                    |                                    |      |     |                                                        |
#     |                        |                                 |      |                                |                       |                    |                |                       |                    |                |                       |                    |                     |                       |                    |
                
#                     |                                                |      |                                   |                               |                         |                               |                         |                               |                              |                               |
#          |                                   |                               |                   |                                |                       |                    |          |                                |                       |                    |          |                                |                       |                    |               |                                |                                        |
                
#                 |                     |
#  |                                |                       |                    |            |                                |                       |                    |     |                                |                       |                    |     |                                |                       |                              |                                |
#          |                               |                                         |                              |                       |                    |                           |                       |                    |                           |                       |                    |                                |                       |                    |
                
#  |         |                                   PRESENTATION                                                |                                |                    |   |                                |                    |   |                                |                    |        |                                |                    |
#                                                                                                                              |                               |     |                                   |                               |     |                                   |                               |          |                                   |                               |
#               |                             /                 \                          |                                                                              |                               |     |                                   |                               |     |                                   |                               |          |                                   |                               |
                
#       |                              Main script to manage several things                    |                                           |               |                                           |               |                                           |                    |                                           |
                
#                          /                      |    v    |                    \
                
#                   like the graphical user interface, style, tabs, and also add some menus       |                                |                                          |      |                                |                                          |      |                                |                                          |           |                                |  
#     |                  !      |                                   |     |                                |                       |                    |                |                       |                    |                |                       |                    |                    |                                           |
#                               |                                   |     |                  
#                  |            |                   Anyway          !                        |                                         |                                |                       |                    |                |                       |                    |                |                       |                    |                    |
                
#             |                      |                 have                                                 |                        |                                         |                                |                       |                    |                |                       |                    |                |                       |                    |                     |                                           |
                

#                |                                  FUN         |                        |                                         |                                |                       |                    |                |                       |                    |                |                       |                    |                    |                                                                      |
                
#                                                        =)
                
#
#                               |                      or                                       |                                                            |                    |                |                       |                    |                |                       |                    |                    |                                           |
                

#             |                              |       DIE ! ! !        |                       |                            |                |                       |                    |                |                       |                    |                    |                                           |#     |                        |                                         |                                |
                
#
#                                                    !                                       |                                |                    |  |                                |                    |  |                                |                    |       |                                |                    |
                
#     |               |                                 !
                
#                 |                                                |            |                                   |                               |                           |                               |                           |                               |                                |                               |
#          |                                  !                                     |
                
#                 |                     |                                                     |                                   |                               |     |                                   |                               |     |                                   |                               |          |                                   |                               |
#  |                          |                       |                    !
#          |                                    |                                         |     |                    |                                    | |     |                    |                                    | |     |                    |                                    |      |     |                    |                                    |
#     |                        |                                 |      |                                |                       |                    |                |                       |                    |                |                       |                    |                    |                                           |
                
#                     |                                                |      |                                   |                               |                         |                               |                         |                               |                              |                               |
#          |                                   |                               |                   |                                |                       |                    |          |                                |                       |                    |          |                                |                       |                    |               |                                                                |
              
#_ _  _ ____ ___ ____ _    _    ____ ___ _ ____ _  _
#| |\ | [__   |  |__| |    |    |__|  |  | |  | |\ |
#| | \| ___]  |  |  | |___ |___ |  |  |  | |__| | \|
         

import sys

from PyQt5.QtCore import Qt
from PyQt5.QtWidgets import QApplication, QMainWindow, QTabWidget, QWidget, QVBoxLayout, QAction,  QMenu, QDialog, QLabel, QVBoxLayout,QTextEdit,QPushButton
from PyQt5.QtGui import QIcon

from components.recorder import Recorder
from components.tables import DarthBMO
from components.overlay import layer0 as Overlay
from Handlers.zoom_handler import enable_zoom
from Handlers.logInfo import logz

from Handlers.cypunk1 import cypunk1Window

#___  ____ _ _ _ ____ ____    ___  _    ____ _  _ ___
#|__] |  | | | | |___ |__/    |__] |    |__| |\ |  |
#|    |__| |_|_| |___ |  \    |    |___ |  | | \|  |
                


#OPENING | https://www.youtube.com/watch?v=_85LaeTCtV8 :3

logger = None #To use Logger in all applications


# Faster to integrate with this window's inception method 
# TODO : rework.class windowCeption(cypunk1Window) to integrate the 2nd main window

class windowCeption(cypunk1Window):
    def __init__(self):
        super().__init__(
            title="Lemme do it",
            window_size="777x400",
            btn_minimize="assets/ico/hide.png",
            btn_show="assets/ico/open.png",
            stylesheet_path= None
        )
        global logger
        # If logger is provided, use it, otherwise create a new logz object with the specified settings
        self.logger = logger or logz.configLogs("Autoclicker", "ERRORS.log", use_qt_dialogs=True)

        # Create an instance of logz to access the ThemeChangedSignal class
        logz_instance = logz("")

        # Create an instance of ThemeChangedSignal to manage theme change events
        self.theme_changed_signal = logz_instance.ThemeChangedSignal()

        # Load the last used theme from the configuration file
        last_theme = self.logger.load_config()

        # Update the theme of the window based on the last used theme
        self.logger.update_theme(self, last_theme)

        # Connect the theme_changed signal to the update_theme_slot method to handle theme changes
        self.theme_changed_signal.theme_changed.connect(self.update_theme_slot)

        # Configure the error handler
        self.tables = DarthBMO(self.logger)
        self.recorder = Recorder(self.logger)
        self.overlay = Overlay(self.logger)

        # Put the main app in the custom window represented by this class
        self.Vlay = QVBoxLayout()
        self.main_page = MainWindow(parent=self)
        self.main_page.set_overlay(self.overlay)
        self.Vlay.addSpacing(28)
        self.Vlay.addWidget(self.main_page)

        self.central_widget.setLayout(self.Vlay)

    # Update themes
    def update_theme_slot(self, theme):
        self.logger.update_theme(self, theme)



class MainWindow(QMainWindow):
    def __init__(self, parent=None):
        super().__init__(parent)

        # Set the logger, overlay, and tables attributes from the parent window
        self.logger = parent.logger
        self.overlay = parent.overlay
        self.tables = parent.tables
        self.recorder = parent.recorder

        # Theme initialization
        self.theme_changed_signal = parent.theme_changed_signal

        # Create a dictionary to store widget instances
        self.widget_instances = {}

        # Enable zooming for this window
        enable_zoom(self)

        self.setWindowIcon(QIcon(self.logger.ressource_path("assets/ico/autoclicker.png")))
        # Initialize user interface
        self.GUI()



    # Connect the theme_changed signal to the update_theme_slot method of the Overlay instance
    def set_overlay(self, overlay_instance):
        self.overlay = overlay_instance
        self.theme_changed_signal.theme_changed.connect(self.overlay.update_theme_slot)

        # Add the Overlay instance to the widget_instances dictionary
        self.widget_instances["overlay"] = self.overlay

    def update_all_widgets_theme(self, theme):
        for widget_instance in self.widget_instances.values():
            self.logger.update_theme(widget_instance, theme)





#____ ___ _  _ ____ ____    ____ _  _ _  _ ____ ___ _ ____ _  _ ____ 
#|  |  |  |__| |___ |__/    |___ |  | |\ | |     |  | |  | |\ | [__  
#|__|  |  |  | |___ |  \    |    |__| | \| |___  |  | |__| | \| ___] 
                                                                    


    def toggle_autoclicker_tab(self, checked):
        # Add or remove the Autoclicker tab based on the checkbox state
        if checked:
            index = self.tabs.addTab(self.autoclicker_tab, "Autoclicker")
            self.tabs.setCurrentIndex(index)
        else:
            self.tabs.removeTab(self.tabs.indexOf(self.autoclicker_tab))

    def toggle_click_recorder_tab(self, checked):
        # Add or remove the Click Recorder tab based on the checkbox state
        if checked:
            index = self.tabs.addTab(self.click_recorder_tab, "Click Recorder")
            self.tabs.setCurrentIndex(index)
        else:
            self.tabs.removeTab(self.tabs.indexOf(self.click_recorder_tab))


    def toggle_overlay_tab(self, checked):
        # Add or remove the Click Recorder tab based on the checkbox state
        if checked:
            index = self.tabs.addTab(self.overlay_tab, "Overlay")
            self.tabs.setCurrentIndex(index)
        else:
            self.tabs.removeTab(self.tabs.indexOf(self.overlay_tab))
    


    def about_dialog(self):
        # Open a dialog box showing information about the program
        self.about_dial = QDialog(self)
        self.about_dial.setWindowTitle("About")
        self.about_dial.setWindowFlag(Qt.WindowContextHelpButtonHint, False)

        about_text = (
"Apologies for any false 'malware' alerts that may have been triggered. "
"The licensing cost for this software is $500 for 6 months, which is why it hasn't been acquired yet.<br><br>"
"Remember that software is free and was initially developed for personal use.<br>"
"I am now sharing it with others aims to help those in search of a good solution.<br>"
"Feel free to follow the project and contribute at: <br><br>"
"<a href='https://github.com/SECRET-GUEST/autoclicker'>SECRET-GUEST/autoclicker</a><br><br>"
"Please note that this version might not be completely stable and could occasionally crash. "
"Nevertheless, its features should work well for most users. Testing it on every machine isn't feasible, "
"so if an issue arises, kindly report it at: <br><br>"
"<a href='https://github.com/SECRET-GUEST/autoclicker/issues'>Report an issue on SECRET-GUEST/autoclicker</a><br><br>"
"Every effort will be made to address reported issues. Thank you."

        )

        self.about_dial_label = QLabel(about_text, self.about_dial)
        self.about_dial_label.setOpenExternalLinks(True)
        self.about_dial_label.setTextFormat(Qt.RichText)
        self.about_dial_label.setWordWrap(True)

        self.close_button = QPushButton("Close", self.about_dial)
        self.close_button.clicked.connect(self.about_dial.close)

        self.Vlay_about = QVBoxLayout(self.about_dial)
        self.Vlay_about.addWidget(self.about_dial_label)
        self.Vlay_about.addWidget(self.close_button)
        self.about_dial.exec_()



    def help_dialog(self):
        # Read the Markdown file
        with open(self.logger.ressource_path('README.md'), 'r', encoding='utf-8') as file:
            md_content = file.read()

        # Display the plain text content in a QDialog
        self.help_dial = QDialog(self)
        self.help_dial.setWindowTitle("Help")
        self.help_dial.setWindowFlag(Qt.WindowContextHelpButtonHint, False)

        self.text_view = QTextEdit(self.help_dial)
        self.text_view.setPlainText(md_content)
        self.text_view.setReadOnly(True)
        self.Vlay_help = QVBoxLayout(self.help_dial)
        self.Vlay_help.addWidget(self.text_view)
        self.help_dial.exec_()


#____ ____ ____ ___  _  _ _ ____ ____ _       _  _ ____ ____ ____    _ _  _ ___ ____ ____ ____ ____ ____ ____ 
#| __ |__/ |__| |__] |__| | |    |__| |       |  | [__  |___ |__/    | |\ |  |  |___ |__/ |___ |__| |    |___ 
#|__] |  \ |  | |    |  | | |___ |  | |___    |__| ___] |___ |  \    | | \|  |  |___ |  \ |    |  | |___ |___ 
   

    def GUI(self):
            # Now the GUI
            menu_bar = self.menuBar()
    
    
            #Menu Windows
            windows_menu = QMenu("Windows", self)
            menu_bar.addMenu(windows_menu)
    
            self.autoclicker_check = QAction("Autoclicker", self, checkable=True)
            self.click_recorder_check = QAction("Click Recorder", self, checkable=True)
            self.overlay_check = QAction("Overlay", self, checkable=True)
    
    
            #Menu Display
            display_menu = QMenu("Display", self)
            menu_bar.addMenu(display_menu)
    
            self.themes_action = QAction("Themes", self)
            self.themes_action.setShortcut("Ctrl+T")
            self.themes_action.triggered.connect(lambda: self.logger.change_theme(self, self.theme_changed_signal))
    
    
    
            #Menu Help
            help_menu = QMenu("Help", self)
            menu_bar.addMenu(help_menu)
    
            about_action = QAction("About", self)
            about_action.triggered.connect(self.about_dialog)
    
            help_action = QAction("?", self)
            help_action.triggered.connect(self.help_dialog)
    
    
            #Tabs 
            self.tabs = QTabWidget()
    
            #Add and configure tabs
            self.overlay_tab = self.overlay
            self.autoclicker_tab = self.tables
            self.click_recorder_tab = self.recorder
            self.click_recorder_tab.set_main_window(self)
            self.click_recorder_tab.start_recording()
    
    
            self.tabs.addTab(self.autoclicker_tab, "Autoclicker")
            self.tabs.addTab(self.click_recorder_tab, "Recorder")
            self.tabs.addTab(self.overlay_tab, "Overlay")
    
            #Connect signals
            self.autoclicker_check.toggled.connect(self.toggle_autoclicker_tab)
            self.click_recorder_check.toggled.connect(self.toggle_click_recorder_tab)
            self.overlay_check.toggled.connect(self.toggle_overlay_tab)
    
            #Set initial check states
            self.autoclicker_check.setChecked(True)
            self.click_recorder_check.setChecked(True)
            self.click_recorder_check.setChecked(False) # powered by scotch tape, thank you Phil👌
            self.overlay_check.setChecked(True)
            self.overlay_check.setChecked(False)
    
            #Add menu actions
            windows_menu.addAction(self.autoclicker_check)
            windows_menu.addAction(self.click_recorder_check)
            windows_menu.addAction(self.overlay_check)
    
            display_menu.addAction(self.themes_action)
            help_menu.addAction(about_action)
            help_menu.addAction(help_action)
    
            #Layout
            main_layout = QVBoxLayout()
            central_widget = QWidget()
            central_widget.setLayout(main_layout)
            self.setCentralWidget(central_widget)
    
            main_layout.addWidget(self.tabs)

#           self.show()


    
    

#____ ____ ____ _  _ ____ ___    _    ____ _  _ _  _ ____ _  _
#|__/ |  | |    |_/  |___  |     |    |__| |  | |\ | |    |__|
#|  \ |__| |___ | \_ |___  |     |___ |  | |__| | \| |___ |  |
                
#ENDING | https://www.youtube.com/watch?v=CgZVrvQZB6U&ab_channel=SECRETGUEST :3


if __name__ == '__main__':
    app = QApplication(sys.argv)

    window = windowCeption()
    window.show()

    sys.exit(app.exec_())
